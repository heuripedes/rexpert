#!/bin/sh

search_dir ()
{
	for i in $@; do
		if [ -d $i ]; then
			exit 0
		fi
	done
	exit 0
}

search_file ()
{
	for i in $@; do
		if [ -f $i ]; then
			return 0
		fi
	done
	return 1
}

TARGET=rexpert
TARGET_DIR=/usr/local
SOURCE_DIR=src
RELEASE_BUILD=0

show_usage ()
{
	echo "Usage: $0 [commands]"
	echo "Commands are:"
	echo "\t-p<path> - Path to install rexpert files. Default: /usr/local"
	echo "\t-r       - Build optimized version of rexpert"
	echo "\t-h       - This help"
}


while getopts 'p:rh': opt; do
	case $opt in
	p)
		TARGET_DIR=$OPTARG
		echo $TARGET_DIR
		exit
	;;
	r)
		RELEASE_BUILD=1
	;;
	h)
		show_usage
		exit
	;;
	?)
		show_usage
		exit
	;;
	esac
done

echo -n "Checking for pkg-config..."

search_file /usr/bin/pkg-config /usr/local/bin/pkg-config

if [ $? -eq 1 ]; then
	echo "not found"
	echo "ERROR: This script requires pkg-config instaled"
	exit
else
	echo "found"
fi

echo -n "Checking for gtk+ 2.0 headers..."

pkg-config --cflags gtk+-2.0 1>&- 2>&-

if [ $? -ne "0" ]; then
	echo "not found"
	echo "ERROR: rexpert requires gtk+ 2.0 headers to compile"
	exit
else
	echo "found"
fi

CFLAGS=`pkg-config --cflags gtk+-2.0`
CLIBS=`pkg-config --libs gtk+-2.0`
OBJS=`ls $SOURCE_DIR/*.c | sed -e "s/\.c/.o/" | tr -s "\n" " "`
SRC=`ls $SOURCE_DIR/*.c | tr -s "\n" " "`

if [ $RELEASE_BUILD -eq 1 ]; then
	BUILDFLAGS=-O2
else
	BUILDFLAGS=-g
fi


rm Makefile
cat << EOF >> Makefile
CFLAGS=$CFLAGS
CLIBS=$CLIBS
OBJS=$OBJS
SRC=$SRC
CC=gcc $BUILDFLAGS -Wall
TARGET=$TARGET
TARGET_DIR=$TARGET_DIR

all: $OBJS
	\$(CC) \$(CLIBS) \$(OBJS) -o \$(TARGET)

clean:
	rm -f $SOURCE_DIR/*.o \$(TARGET)

install:
	mkdir -p \$(TARGET_DIR)
	cp \$(TARGET) \$(TARGET_DIR)
	chmod 755 \$(TARGET_DIR)/\$(TARGET)

uninstall:
	rm -f \$(TARGET_DIR)/\$(TARGET)

EOF

for i in $OBJS; do
	CFILE=`echo $i | sed -e "s/\.o/.c/"`
	echo "$i: $CFILE" >> Makefile
	echo "\t\$(CC) \$(CFLAGS)-c $CFILE -o $i\n" >> Makefile
done



echo 
echo "Run 'make' to compile rexpert"

