#!/bin/sh

TARGET=rexpert
TARGET_DIR=/usr/local
SOURCE_DIR=src

search_dir ()
{
	for i in $@; do
		if [ -d $i ]; then
			exit 0
		fi
	done
	exit 0
}

search_file ()
{
	for i in $@; do
		if [ -f $i ]; then
			return 0
		fi
	done
	return 1
}

echo -n "Checking for pkg-config..."

search_file /usr/bin/pkg-config /usr/local/bin/pkg-config

if [ $? -eq 1 ]; then
	echo "not found"
	echo "ERROR: This script requires pkg-config instaled"
	exit
else
	echo "found"
fi

echo -n "Checking for gtk+ 2.0 headers..."

pkg-config --cflags gtk+-2.0 1>&- 2>&-

if [ $? != "0" ]; then
	echo "not found"
	echo "ERROR: rexpert requires gtk+ 2.0 headers to compile"
	exit
else
	echo "found"
fi

CFLAGS=`pkg-config --cflags gtk+-2.0`
CLIBS=`pkg-config --libs gtk+-2.0`
OBJS=`ls $SOURCEDIR/*.c | sed -e "s/\.c/.o/" | tr -s "\n" " "`
SRC=`ls $SOURCEDIR/*.c | tr -s "\n" " "`

rm Makefile
cat << EOF >> Makefile
CFLAGS=$CFLAGS
CLIBS=$CLIBS
OBJS=$OBJS
SRC=$SRC
CC=gcc -g -Wall
TARGET=$TARGET
TARGET_DIR=$TARGET_DIR

all: $OBJS
	\$(CC) \$(CLIBS) \$(OBJS) -o \$(TARGET)

clean:
	rm -f $SOURCEDIR/*.o gregex

install:
	mkdir -p \$(TARGET_DIR)
	cp \$(TARGET) \$(TARGET_DIR)
	chmod 755 \$(TARGET_DIR)/\$(TARGET)

uninstall:
	rm -f /usr/local/lib/geany/\$(TARGET)

deinstall:
	rm -f /usr/local/lib/geany/\$(TARGET)

EOF

for i in $OBJS; do
	CFILE=`echo $i | sed -e "s/\.o/.c/"`
	echo "$i: $CFILE" >> Makefile
	echo "\t\$(CC) \$(CFLAGS)-c $CFILE -o $i\n" >> Makefile
done

